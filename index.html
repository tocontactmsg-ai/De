<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>الدلالة — أحدث الإعلانات</title>
<style>
  :root{
    --bg:#f8fafc;
    --card:#ffffff;
    --border:#e2e8f0;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#0284c7;
  }
  *{box-sizing:border-box}
  body{
    font-family:system-ui,"Segoe UI",Roboto,Arial;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding:12px;
  }
  header{
    background:linear-gradient(120deg,#0ea5e9,#0369a1);
    color:white;
    padding:14px;
    border-radius:14px;
    margin-bottom:14px;
  }
  h1{margin:0;font-size:22px}
  .actions{
    display:flex;
    gap:8px;
    margin-top:10px;
  }
  input{
    flex:1;
    padding:9px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:14px;
  }
  button{
    padding:9px 14px;
    border-radius:8px;
    border:none;
    background:var(--accent);
    color:white;
    cursor:pointer;
    font-size:14px;
  }
  button:hover{opacity:.9}
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
    gap:12px;
  }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .thumb{
    width:100%;
    height:160px;
    border-radius:10px;
    object-fit:cover;
    background:#1e293b;
  }
  .title{
    font-size:15px;
    font-weight:600;
    line-height:1.3;
  }
  .price{
    font-size:15px;
    font-weight:600;
    color:#047857;
  }
  .location{
    font-size:13px;
    color:var(--muted);
  }
  .id{
    font-size:12px;
    color:var(--accent);
    margin-top:4px;
  }
  .empty{
    text-align:center;
    margin-top:25px;
    font-size:14px;
    color:var(--muted);
  }
</style>
</head>
<body>

<header>
  <h1>موقع الدلالة — إعلانات السودان</h1>
  <div class="actions">
    <input id="searchInput" placeholder="بحث — مثال: عربية، أثاث، موبايل..." />
    <button id="refreshBtn">تحديث</button>
  </div>
</header>

<div id="adsGrid" class="grid"></div>
<div id="emptyMsg" class="empty" style="display:none">لا توجد إعلانات مطابقة</div>

<script>
/* ✅ ضع اسم مستخدم GitHub والريبو هنا */
const REPO = "YOUR_USERNAME/YOUR_REPO";

/* ✅ يجلب قائمة ملفات ads */
async function listAds(){
  const url = `https://api.github.com/repos/${REPO}/contents/ads`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("فشل تحميل قائمة الإعلانات");
  return res.json();
}

/* ✅ يحول Base64 إلى نص UTF-8 */
function decodeBase64(b64){
  const bin = atob(b64.replace(/\n/g,""));
  return new TextDecoder("utf-8").decode(
    Uint8Array.from(bin, c => c.charCodeAt(0))
  );
}

/* ✅ يجلب محتوى إعلان واحد */
async function loadAd(file){
  const res = await fetch(file.url);
  const data = await res.json();
  return JSON.parse(decodeBase64(data.content));
}

/* ✅ تحميل جميع الإعلانات */
async function loadAds(){
  const container = document.getElementById("adsGrid");
  container.innerHTML = "<div class='empty'>جاري التحميل...</div>";

  try {
    const files = await listAds();
    const ads = [];

    for(const f of files){
      if(f.name.endsWith(".json")){
        const ad = await loadAd(f);
        ads.push(ad);
      }
    }

    renderAds(ads);
    window.ALL_ADS = ads; // نخزن للبحث لاحقًا
  } catch(err){
    container.innerHTML = `<div class='empty'>⚠️ خطأ: ${err.message}</div>`;
  }
}

/* ✅ عرض الإعلانات */
function renderAds(ads){
  const grid = document.getElementById("adsGrid");
  const empty = document.getElementById("emptyMsg");

  grid.innerHTML = "";

  if(!ads.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  for(const ad of ads){
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.className = "thumb";

    const src =
      ad.primary_image ||
      (ad.images && ad.images[0]) ||
      null;

    if(src){
      img.src = `https://raw.githubusercontent.com/${REPO}/main/${src}`;
    }

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = ad.title || "بدون عنوان";

    const price = document.createElement("div");
    price.className = "price";
    price.textContent = ad.price ? `${ad.price} SDG` : "";

    const loc = document.createElement("div");
    loc.className = "location";
    loc.textContent = ad.location || "";

    const id = document.createElement("div");
    id.className = "id";
    id.textContent = `ID: ${ad.id}`;

    card.append(img,title,price,loc,id);
    grid.appendChild(card);
  }
}

/* ✅ البحث الفوري */
document.getElementById("searchInput").oninput = e => {
  const q = e.target.value.trim().toLowerCase();
  if(!q) return renderAds(window.ALL_ADS || []);
  const filtered = (window.ALL_ADS || []).filter(a =>
    (a.title || "").toLowerCase().includes(q) ||
    (a.description || "").toLowerCase().includes(q) ||
    (a.location || "").toLowerCase().includes(q)
  );
  renderAds(filtered);
};

/* ✅ زر تحديث */
document.getElementById("refreshBtn").onclick = () => loadAds();

/* ✅ تحميل عند فتح الصفحة */
loadAds();
</script>

</body>
</html>
