<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (GitHub + PAT)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",sans-serif}
  body{margin:0;background:#f3f7fc;color:#0b1220;line-height:1.5}
  a{text-decoration:none;color:inherit}
  code{background:#e2e8f0;border-radius:4px;padding:0 4px;font-size:12px}
  .shell{max-width:1150px;margin:0 auto;padding:12px}
  header{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;border-radius:16px;padding:14px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,0.14);display:flex;align-items:center;justify-content:center;font-weight:800}
  .brandTitle{font-size:20px;font-weight:800}
  .brandSub{font-size:13px;opacity:.9}
  .connectBox{display:flex;flex-direction:column;gap:4px;align-items:flex-end}
  .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .small{font-size:13px}
  .muted{color:#e0f2fe}
  .mutedDark{color:#64748b}
  input,select{padding:7px 9px;border-radius:9px;border:1px solid #d4dbe9;background:#f9fbff;font-size:13px}
  input:focus,select:focus{outline:none;border-color:#0ea5e9;box-shadow:0 0 0 1px rgba(14,165,233,.22)}
  .tokenInput{min-width:180px}
  .btn{padding:7px 10px;border-radius:9px;border:1px solid #dbeafe;background:#eff6ff;color:#0369a1;font-size:13px;cursor:pointer}
  .btn.primary{background:#0ea5e9;border-color:#0284c7;color:#fff}
  .btn.ghost{background:transparent;border-color:rgba(255,255,255,0.3);color:#e0f2fe}
  .btn.danger{background:#fee2e2;border-color:#fecaca;color:#b91c1c}
  .btn.small{font-size:12px;padding:5px 8px;border-radius:999px}
  .panel{background:#ffffff;border-radius:16px;padding:12px;border:1px solid #e2e8f0;box-shadow:0 10px 26px rgba(15,23,42,.06);margin-bottom:12px}
  .panelHead{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .panelTitle{font-weight:700;font-size:15px}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .filters input{min-width:160px}
  .filters select{min-width:120px}
  .tag{font-size:12px;color:#6b7280}
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px}
  @media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:#fff;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 8px 22px rgba(15,23,42,.05);padding:10px;display:flex;flex-direction:column;gap:6px}
  .cardTitle{font-weight:700;font-size:15px;color:#0f172a}
  .cardDesc{font-size:13px;color:#4b5563;max-height:3.4em;overflow:hidden;text-overflow:ellipsis}
  .cardFooter{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .badge{background:#eff6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-size:11px;font-weight:600}
  .pill{background:#f3f4f6;color:#4b5563;border-radius:999px;padding:3px 7px;font-size:11px}
  .ref{margin-right:auto;font-size:12px;color:#0f172a;font-weight:600}
  .statusChip{padding:3px 7px;border-radius:999px;font-size:11px;font-weight:600}
  .statusChip.accepted{background:#dcfce7;color:#16a34a}
  .statusChip.pending{background:#fef9c3;color:#854d0e}
  .statusChip.rejected{background:#fee2e2;color:#b91c1c}
  .btnRow{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
  .empty{padding:16px;text-align:center}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f172a;color:#f9fafb;padding:8px 12px;border-radius:10px;font-size:13px;box-shadow:0 12px 30px rgba(15,23,42,.45);display:none;z-index:60}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.55);z-index:50}
  .modal.open{display:flex}
  .modalCard{background:#ffffff;border-radius:16px;max-width:900px;width:96%;max-height:92vh;overflow:auto;padding:14px;box-shadow:0 18px 40px rgba(15,23,42,.4)}
  .modalHead{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;flex-wrap:wrap}
  .modalTitle{font-size:18px;font-weight:800;color:#020617}
  .modalMeta{font-size:13px;color:#6b7280;margin-top:4px}
  .modalContent{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
  .modalLeft,.modalRight{flex:1;min-width:230px}
  .field{margin-bottom:8px}
  .field label{display:block;font-size:13px;font-weight:600;margin-bottom:3px}
  .field input,.field textarea{width:100%;padding:8px 9px;border-radius:10px;border:1px solid #d4dbe9;background:#f9fbff;font-size:13px}
  .field textarea{min-height:80px;resize:vertical}
  .field input:focus,.field textarea:focus{outline:none;border-color:#0ea5e9;box-shadow:0 0 0 1px rgba(14,165,233,.22)}
  .modalFooter{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="shell">
  <header>
    <div class="brand">
      <div class="logo">EL</div>
      <div>
        <div class="brandTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</div>
        <div class="brandSub">ØªØªØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ù„Ø¯ <code>ads/</code> ÙˆÙ…Ù„Ù <code>order.json</code> ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ GitHub Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PAT</div>
      </div>
    </div>
    <div class="connectBox">
      <div class="row">
        <input id="repoInput" placeholder="user/repo" title="Ù…Ø«Ø§Ù„: username/eldelala">
        <input id="tokenInput" class="tokenInput" placeholder="GitHub PAT (Ù„Ù† ÙŠÙØ­ÙØ¸ Ø¯Ø§Ø¦Ù…Ø§Ù‹)">
        <button id="connectBtn" class="btn primary">Ø§ØªØµÙ„</button>
      </div>
      <div class="row">
        <span id="statusLabel" class="small muted">ØºÙŠØ± Ù…ØªØµÙ„</span>
        <button id="clearSessionBtn" class="btn ghost small">Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª</button>
      </div>
    </div>
  </header>

  <section class="panel">
    <div class="panelHead">
      <div class="panelTitle">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
      <div class="tag">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† <code>order.json</code> Ùˆ <code>ads/*.json</code> Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø±ÙŠØ¨Ùˆ</div>
    </div>
    <div class="filters">
      <input id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹">
      <select id="statusFilter">
        <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="accepted">Ù…Ù‚Ø¨ÙˆÙ„</option>
        <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
        <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
      </select>
      <select id="catFilter">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
      </select>
      <button id="reloadBtn" class="btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub</button>
      <button id="saveOrderBtn" class="btn">Ø­ÙØ¸ order.json Ø¹Ù„Ù‰ GitHub</button>
    </div>
    <div id="cardsGrid" class="grid"></div>
    <div id="emptyBox" class="empty" style="display:none">
      Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§
      <div class="mutedDark small">ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ <code>order.json</code> ÙˆÙ…Ø¬Ù„Ø¯ <code>ads/</code> ÙÙŠ Ø§Ù„Ø±ÙŠØ¨Ùˆ.</div>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div class="modalTitle" id="m_title"></div>
        <div class="modalMeta" id="m_meta"></div>
      </div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <span id="m_status" class="statusChip pending"></span>
        <span id="m_ref" class="pill"></span>
        <button class="btn" id="m_close">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="modalContent">
      <div class="modalLeft">
        <div class="field">
          <label for="m_title_input">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="m_title_input">
        </div>
        <div class="field">
          <label for="m_desc_input">Ø§Ù„ÙˆØµÙ</label>
          <textarea id="m_desc_input"></textarea>
        </div>
        <div class="field">
          <label for="m_price_input">Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="m_price_input">
        </div>
      </div>
      <div class="modalRight">
        <div class="field">
          <label for="m_loc_input">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
          <input id="m_loc_input">
        </div>
        <div class="field">
          <label for="m_phone_input">Ø§Ù„Ù‡Ø§ØªÙ / ÙˆØ§ØªØ³Ø§Ø¨</label>
          <input id="m_phone_input">
        </div>
        <div class="field">
          <label for="m_cat_input">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <input id="m_cat_input">
        </div>
        <div class="field">
          <label for="m_status_select">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="m_status_select">
            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            <option value="accepted">Ù…Ù‚Ø¨ÙˆÙ„</option>
            <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modalFooter">
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn primary" id="m_saveGithub">Ø­ÙØ¸ ÙÙŠ GitHub</button>
        <button class="btn" id="m_downloadJson">ØªÙ†Ø²ÙŠÙ„ JSON</button>
        <button class="btn" id="m_makePng">Ø¨Ø·Ø§Ù‚Ø© PNG</button>
      </div>
      <div class="tag">Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠÙÙƒØªØ¨ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù…Ù„Ù <code>ads/[id].json</code> ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.</div>
    </div>
  </div>
</div>

<!-- JsBarcode Ù„Ø¹Ù…Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø­Ù‚ÙŠÙ‚ÙŠ -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<script>
let REPO = '';
let TOKEN = '';
let BRANCH = 'main';

let ads = [];        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† GitHub
let orderIds = [];   // IDs Ù…Ù† order.json
let ghFiles = {};    // path -> {sha}
let currentAd = null;

const repoInput   = document.getElementById('repoInput');
const tokenInput  = document.getElementById('tokenInput');
const connectBtn  = document.getElementById('connectBtn');
const clearSessionBtn = document.getElementById('clearSessionBtn');
const statusLabel = document.getElementById('statusLabel');

const gridEl       = document.getElementById('cardsGrid');
const emptyBoxEl   = document.getElementById('emptyBox');
const searchEl     = document.getElementById('searchInput');
const statusFilter = document.getElementById('statusFilter');
const catFilter    = document.getElementById('catFilter');
const reloadBtn    = document.getElementById('reloadBtn');
const saveOrderBtn = document.getElementById('saveOrderBtn');
const toastEl      = document.getElementById('toast');

// modal elements
const modal         = document.getElementById('modal');
const m_close       = document.getElementById('m_close');
const m_title       = document.getElementById('m_title');
const m_meta        = document.getElementById('m_meta');
const m_statusChip  = document.getElementById('m_status');
const m_ref         = document.getElementById('m_ref');
const m_title_in    = document.getElementById('m_title_input');
const m_desc_in     = document.getElementById('m_desc_input');
const m_price_in    = document.getElementById('m_price_input');
const m_loc_in      = document.getElementById('m_loc_input');
const m_phone_in    = document.getElementById('m_phone_input');
const m_cat_in      = document.getElementById('m_cat_input');
const m_status_sel  = document.getElementById('m_status_select');
const m_saveGithub  = document.getElementById('m_saveGithub');
const m_downloadBtn = document.getElementById('m_downloadJson');
const m_makePngBtn  = document.getElementById('m_makePng');

function showToast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = 'block';
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=> toastEl.style.display='none',2500);
}

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);}
function debounce(fn,delay){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),delay);}}

// ===== GitHub helpers =====
function getGitHubHeaders(){
  const h = {'Accept':'application/vnd.github+json'};
  if(TOKEN) h.Authorization = `Bearer ${TOKEN}`;
  return h;
}

async function ghGetFile(path){
  const url = `https://api.github.com/repos/${REPO}/contents/${path}?ref=${BRANCH}`;
  const res = await fetch(url,{headers:getGitHubHeaders()});
  if(!res.ok){
    throw new Error(`GitHub GET ${path} failed: ${res.status}`);
  }
  const data = await res.json();
  const contentStr = atob((data.content || '').replace(/\n/g,''));
  ghFiles[path] = {sha:data.sha};
  return {text:contentStr,sha:data.sha};
}

async function ghPutFile(path, contentText, message){
  const url = `https://api.github.com/repos/${REPO}/contents/${path}`;
  const sha = ghFiles[path]?.sha;
  const b64 = btoa(unescape(encodeURIComponent(contentText)));
  const body = {
    message: message || `Update ${path}`,
    content: b64,
    branch: BRANCH
  };
  if(sha) body.sha = sha;
  const res = await fetch(url,{
    method:'PUT',
    headers:Object.assign({'Content-Type':'application/json'}, getGitHubHeaders()),
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const txt = await res.text();
    throw new Error(`GitHub PUT ${path} failed: ${res.status} ${txt}`);
  }
  const data = await res.json();
  ghFiles[path] = {sha:data.content.sha};
  return data;
}

// ===== Ø§ØªØµØ§Ù„ =====
connectBtn.onclick = async ()=>{
  const r = repoInput.value.trim();
  const t = tokenInput.value.trim();
  if(!r || !t){
    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙˆØ§Ù„ØªÙˆÙƒÙ†');
    return;
  }
  REPO = r;
  TOKEN = t;
  sessionStorage.setItem('eld_repo', REPO);
  sessionStorage.setItem('eld_token', TOKEN);
  statusLabel.textContent = `Ù…ØªØµÙ„ Ø¨Ù€ ${REPO} (main)`;
  showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ sessionStorage â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ… Ø®Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©');
  await loadAdsFromGitHub();
};

clearSessionBtn.onclick = ()=>{
  sessionStorage.removeItem('eld_repo');
  sessionStorage.removeItem('eld_token');
  REPO=''; TOKEN='';
  repoInput.value='';
  tokenInput.value='';
  statusLabel.textContent='ØºÙŠØ± Ù…ØªØµÙ„';
  showToast('ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©');
};

// ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ… Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
(function initFromSession(){
  const r = sessionStorage.getItem('eld_repo');
  const t = sessionStorage.getItem('eld_token');
  if(r && t){
    REPO = r; TOKEN = t;
    repoInput.value = r;
    tokenInput.value = t.replace(/.(?=.{4})/g,'*'); // Ø¥Ø®ÙØ§Ø¡ ØªÙ‚Ø±ÙŠØ¨ÙŠ (Ø´ÙƒÙ„ ÙÙ‚Ø·)
    statusLabel.textContent = `Ù…ØªØµÙ„ (Ù…Ø®Ø²Ù†) â€” Ø§Ø¶ØºØ· "Ø§ØªØµÙ„" Ù„ØªÙØ¹ÙŠÙ„`;
  }
})();

// ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† GitHub =====
async function loadAdsFromGitHub(){
  if(!REPO || !TOKEN){
    alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙˆØ§Ù„ØªÙˆÙƒÙ† Ø«Ù… Ø§Ø¶ØºØ· "Ø§ØªØµÙ„" Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
  try{
    statusLabel.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ order.json ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª...';
    ghFiles = {};
    // order.json
    const order = await ghGetFile('order.json');
    try{
      orderIds = JSON.parse(order.text);
      if(!Array.isArray(orderIds)) orderIds = [];
    }catch(e){
      orderIds = [];
    }
    const loaded = [];
    for(const id of orderIds){
      const path = `ads/${id}.json`;
      try{
        const f = await ghGetFile(path);
        const ad = JSON.parse(f.text);
        loaded.push(ad);
      }catch(e){
        console.warn('skip',id,e);
      }
    }
    ads = loaded;
    statusLabel.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${ads.length} Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† ${REPO}`;
    populateFilters();
    renderGrid();
  }catch(e){
    console.error(e);
    statusLabel.textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† GitHub';
    showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙˆØ§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
    ads = [];
    orderIds = [];
    renderGrid();
  }
}

reloadBtn.onclick = ()=> loadAdsFromGitHub();

function populateFilters(){
  const cats = Array.from(new Set(ads.map(a=>a.category||'Ø¹Ø§Ù…')));
  catFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>' +
    cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
}

// ===== Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª =====
function renderGrid(){
  const q = (searchEl.value || '').trim().toLowerCase();
  const st = statusFilter.value;
  const cat = catFilter.value;

  let list = ads.slice();
  if(st) list = list.filter(a => (a.status || 'pending') === st);
  if(cat) list = list.filter(a => (a.category || 'Ø¹Ø§Ù…') === cat);
  if(q){
    list = list.filter(a =>
      (a.title||'').toLowerCase().includes(q) ||
      (a.description||'').toLowerCase().includes(q) ||
      (a.id||'').toLowerCase().includes(q) ||
      (a.location||'').toLowerCase().includes(q)
    );
  }

  gridEl.innerHTML = '';
  if(!list.length){
    emptyBoxEl.style.display = 'block';
    return;
  }
  emptyBoxEl.style.display = 'none';

  list.forEach(ad=>{
    const card = document.createElement('article');
    card.className = 'card';
    const title = escapeHtml(ad.title || '');
    const desc  = escapeHtml(ad.description || '');
    const loc   = escapeHtml(ad.location || '');
    const price = escapeHtml(ad.price || '');
    const ref   = escapeHtml(ad.id || '');
    const cat   = escapeHtml(ad.category || 'Ø¹Ø§Ù…');
    const st    = (ad.status || 'pending').toLowerCase();

    card.innerHTML = `
      <div class="cardTitle">${title || '(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)'}</div>
      <div class="cardDesc">${desc}</div>
      <div class="cardFooter">
        <span class="badge">${cat}</span>
        ${loc ? `<span class="pill">ğŸ“ ${loc}</span>` : ''}
        ${price ? `<span class="pill">${price}</span>` : ''}
        <span class="ref">${ref}</span>
        <span class="statusChip ${st}">${st === 'accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':st==='rejected'?'Ù…Ø±ÙÙˆØ¶':'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}</span>
      </div>
      <div class="btnRow">
        <button class="btn small" data-action="view">Ø¹Ø±Ø¶ / ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn small" data-action="json">ØªÙ†Ø²ÙŠÙ„ JSON</button>
        <button class="btn small" data-action="png">Ø¨Ø·Ø§Ù‚Ø© PNG</button>
      </div>
    `;
    card.querySelector('[data-action="view"]').onclick = ()=> openModal(ad);
    card.querySelector('[data-action="json"]').onclick = ()=> downloadJson(ad);
    card.querySelector('[data-action="png"]').onclick  = ()=> makePngForAd(ad);
    gridEl.appendChild(card);
  });
}

searchEl.addEventListener('input', debounce(renderGrid,250));
statusFilter.addEventListener('change', renderGrid);
catFilter.addEventListener('change', renderGrid);

// ===== Ù…ÙˆØ¯Ø§Ù„ =====
function openModal(ad){
  currentAd = JSON.parse(JSON.stringify(ad)); // clone
  m_title.textContent = currentAd.title || '';
  m_meta.textContent  = currentAd.location ? `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${currentAd.location}` : '';
  m_ref.textContent   = currentAd.id || '';
  const st = (currentAd.status || 'pending').toLowerCase();
  m_statusChip.textContent = st==='accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':st==='rejected'?'Ù…Ø±ÙÙˆØ¶':'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
  m_statusChip.className = 'statusChip '+st;

  m_title_in.value = currentAd.title || '';
  m_desc_in.value  = currentAd.description || '';
  m_price_in.value = currentAd.price || '';
  m_loc_in.value   = currentAd.location || '';
  m_phone_in.value = currentAd.phone || currentAd.whatsapp || '';
  m_cat_in.value   = currentAd.category || '';
  m_status_sel.value = st;

  modal.classList.add('open');
}

m_close.onclick = ()=> modal.classList.remove('open');

function applyModalEdits(){
  if(!currentAd) return;
  currentAd.title       = m_title_in.value.trim() || currentAd.title;
  currentAd.description = m_desc_in.value.trim();
  currentAd.price       = m_price_in.value.trim();
  currentAd.location    = m_loc_in.value.trim();
  const phone = m_phone_in.value.trim();
  if(phone){ currentAd.phone = phone; currentAd.whatsapp = phone; }
  currentAd.category    = m_cat_in.value.trim() || currentAd.category || 'Ø¹Ø§Ù…';
  currentAd.status      = m_status_sel.value;
  currentAd.updated_at  = new Date().toISOString();
  const st = currentAd.status.toLowerCase();
  m_statusChip.textContent = st==='accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':st==='rejected'?'Ù…Ø±ÙÙˆØ¶':'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
  m_statusChip.className = 'statusChip '+st;
}

// Ø­ÙØ¸ ÙÙŠ GitHub
m_saveGithub.onclick = async ()=>{
  if(!currentAd){return;}
  if(!REPO || !TOKEN){
    alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙˆØ§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ø¶ØºØ· "Ø§ØªØµÙ„" Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
  applyModalEdits();
  const path = `ads/${currentAd.id}.json`;
  try{
    const text = JSON.stringify(currentAd,null,2);
    await ghPutFile(path,text,`Update ad ${currentAd.id}`);
    showToast(`ØªÙ… Ø­ÙØ¸ ${path} ÙÙŠ GitHub`);
    // Ø­Ø¯Ø« Ø§Ù„Ù†Ø³Ø®Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    const idx = ads.findIndex(a=>a.id===currentAd.id);
    if(idx>=0) ads[idx] = currentAd;
    renderGrid();
  }catch(e){
    console.error(e);
    showToast('ÙØ´Ù„ Ø­ÙØ¸ JSON ÙÙŠ GitHub â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
  }
};

// ØªÙ†Ø²ÙŠÙ„ JSON ÙÙ‚Ø·
function downloadJson(ad){
  const data = JSON.stringify(ad,null,2);
  const blob = new Blob([data],{type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `${ad.id||'ad'}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ JSON â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù…Ø¬Ù„Ø¯ ads ÙÙŠ GitHub Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª.');
}

m_downloadBtn.onclick = ()=>{ if(currentAd) downloadJson(currentAd); };

// Ø­ÙØ¸ order.json ÙÙŠ GitHub
saveOrderBtn.onclick = async ()=>{
  if(!REPO || !TOKEN){
    alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙˆØ§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ø¶ØºØ· "Ø§ØªØµÙ„" Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
  // Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ†Ø§ orderIds Ø§Ø³ØªØ¹Ù…Ù„ IDs Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ads:
  if(!orderIds.length){
    orderIds = ads.map(a=>a.id).filter(Boolean);
  }
  if(!orderIds.length){
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ IDs Ù„Ø­ÙØ¸Ù‡Ø§ ÙÙŠ order.json.');
    return;
  }
  const text = JSON.stringify(orderIds,null,2);
  try{
    await ghPutFile('order.json',text,'Update order.json');
    showToast('ØªÙ… Ø­ÙØ¸ order.json ÙÙŠ GitHub');
  }catch(e){
    console.error(e);
    showToast('ÙØ´Ù„ Ø­ÙØ¸ order.json ÙÙŠ GitHub');
  }
};

// ===== PNG card with barcode =====
m_makePngBtn.onclick = ()=>{ if(currentAd) makePngForAd(currentAd); };

async function makePngForAd(ad){
  const meta = {
    id: ad.id,
    title: ad.title,
    description: ad.description,
    price: ad.price,
    location: ad.location,
    phone: ad.phone || ad.whatsapp || '',
    category: ad.category,
    status: ad.status || 'pending',
    created_at: ad.created_at || null,
    updated_at: ad.updated_at || null
  };
  const ab = await createCardWithBarcode(null, meta);
  const blob = new Blob([ab],{type:'image/png'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `${ad.id||'ad'}-confirmation.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø¨Ø·Ø§Ù‚Ø© PNG â€” ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ ÙƒØ¯Ù„ÙŠÙ„ ØªØ£ÙƒÙŠØ¯.');
}

// ==== embed meta in PNG ====
function embedMeta(arrayBuffer, meta){
  const data = new Uint8Array(arrayBuffer);
  function readU32(p){return (data[p]<<24)|(data[p+1]<<16)|(data[p+2]<<8)|data[p+3];}
  function crc32(buf){
    if(!crc32.table){
      crc32.table = new Uint32Array(256).map((_,n)=>{let c=n;for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);return c>>>0;});
    }
    let crc=0xffffffff;
    for(let i=0;i<buf.length;i++) crc=(crc>>>8)^crc32.table[(crc^buf[i])&0xff];
    return (crc^0xffffffff)>>>0;
  }
  let pos=8;
  while(pos<data.length){
    const len=readU32(pos);
    const type=String.fromCharCode(...data.slice(pos+4,pos+8));
    if(type==='IEND') break;
    pos+=8+len+4;
  }
  const before=data.slice(0,pos);
  const after=data.slice(pos);
  const encoder=new TextEncoder();
  const textData=encoder.encode('eldelala-meta\0'+JSON.stringify(meta));
  const len=textData.length;
  const lenBuf=new Uint8Array([(len>>>24)&255,(len>>>16)&255,(len>>>8)&255,len&255]);
  const typeBuf=new Uint8Array([116,69,88,116]); // tEXt
  const crcInput=new Uint8Array(typeBuf.length+textData.length);
  crcInput.set(typeBuf,0);
  crcInput.set(textData,typeBuf.length);
  const crc=crc32(crcInput);
  const crcBuf=new Uint8Array([(crc>>>24)&255,(crc>>>16)&255,(crc>>>8)&255,crc&255]);
  const out=new Uint8Array(before.length+4+4+textData.length+4+after.length);
  let o=0;
  out.set(before,o);o+=before.length;
  out.set(lenBuf,o);o+=4;
  out.set(typeBuf,o);o+=4;
  out.set(textData,o);o+=textData.length;
  out.set(crcBuf,o);o+=4;
  out.set(after,o);
  return out.buffer;
}

async function createCardWithBarcode(imageFile, meta){
  const width = 1400;
  const imgH  = 700;
  const footerH = 260;
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = imgH + footerH;
  const ctx = canvas.getContext('2d');

  const g = ctx.createLinearGradient(0,0,width,canvas.height);
  g.addColorStop(0,'#ffffff'); g.addColorStop(1,'#e0f2fe');
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

  roundedRect(ctx,40,40,width-80,imgH+footerH-60,26);
  ctx.fillStyle='#ffffff';
  ctx.shadowColor='rgba(15,23,42,.16)';
  ctx.shadowBlur=32;
  ctx.fill();
  ctx.shadowBlur=0;

  const imgX=80,imgY=80,imgW=width-160,imgAreaH=imgH-40;
  roundedRect(ctx,imgX,imgY,imgW,imgAreaH,14);
  ctx.fillStyle='#020617'; ctx.fill();
  ctx.fillStyle='#f9fafb';
  ctx.font='bold 52px sans-serif';
  ctx.textAlign='center';
  wrapText(ctx, meta.title || meta.id || 'Ø¥Ø¹Ù„Ø§Ù†', width/2, imgY+imgAreaH/2, imgW-80, 52);

  const footX=100,footY=imgY+imgAreaH+22,footW=width-200,footH=footerH-60;
  const g2 = ctx.createLinearGradient(footX,footY,footX+footW,footY+footH);
  g2.addColorStop(0,'#082f49'); g2.addColorStop(1,'#0f766e');
  roundedRect(ctx,footX,footY,footW,footH,14);
  ctx.fillStyle=g2; ctx.fill();

  ctx.beginPath();
  ctx.arc(footX+60,footY+60,36,0,Math.PI*2);
  ctx.fillStyle='#f9fafb'; ctx.fill();
  ctx.fillStyle='#0f172a';
  ctx.font='bold 20px sans-serif';
  ctx.textAlign='center';
  ctx.fillText('EL',footX+60,footY+66);

  ctx.font='bold 50px sans-serif';
  ctx.textAlign='center';
  ctx.fillStyle='rgba(0,0,0,0.22)';
  ctx.fillText(meta.id,width/2+3,footY+80+3);
  ctx.fillStyle='#f9fafb';
  ctx.fillText(meta.id,width/2,footY+80);

  const bcCanvas = document.createElement('canvas');
  const bcWidth = Math.floor(footW - 260);
  const bcHeight = 100;
  bcCanvas.width = bcWidth;
  bcCanvas.height = bcHeight;
  try{
    JsBarcode(bcCanvas, meta.id || 'NO-ID', {format:"CODE128",displayValue:false,height:bcHeight,margin:0});
    ctx.drawImage(bcCanvas, footX+120, footY+100, bcWidth, bcHeight);
  }catch(e){
    console.warn('JsBarcode failed',e);
  }

  ctx.fillStyle='rgba(226,232,240,0.95)';
  ctx.font='16px sans-serif';
  ctx.textAlign='left';
  ctx.fillText('Ø£Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ£Ø±Ø³Ù„Ù‡Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ÙƒØ¯Ù„ÙŠÙ„ Ù„Ù„ØªØ£ÙƒÙŠØ¯', footX+26,footY+footH-22);

  roundedRect(ctx,footX+footW-20,footY+14,8,footH-28,5);
  ctx.fillStyle='rgba(250,204,21,0.55)';
  ctx.fill();

  const blob = await new Promise(res=>canvas.toBlob(res,'image/png',1));
  const ab   = await blob.arrayBuffer();
  return embedMeta(ab, meta);
}

function roundedRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

function wrapText(ctx,text,x,y,maxWidth,lineHeight){
  const words = String(text||'').split(' ');
  let line='';let cy=y;
  for(let i=0;i<words.length;i++){
    const test=line+words[i]+' ';
    if(ctx.measureText(test).width > maxWidth && i>0){
      ctx.fillText(line,x,cy);
      line=words[i]+' ';
      cy+=lineHeight;
    }else{
      line=test;
    }
  }
  ctx.fillText(line,x,cy);
}
</script>
</body>
</html>
